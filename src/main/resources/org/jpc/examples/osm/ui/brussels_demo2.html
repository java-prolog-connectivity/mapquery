<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>

	<meta charset='utf-8' />
	<title>Logic Maps</title>
	<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
	<script type='text/javascript' src='js/OpenLayers-2.12/OpenLayers.js'></script>
	<script type='text/javascript'>
	(function ($) {
		var map;
		var vectorLayer;
		var features;
		
		function initMap() {
			//Brussels coordinates
			var lat=50.8467493;
			var lon=4.3524950;
			
			//Starting zoom level
			var zoom=11;

			var osm_format;
			
			map = new OpenLayers.Map('map_element', {
				maxResolution: 156543.0399,
			    numZoomLevels: 16,
				units: 'm', //meters
				projection: new OpenLayers.Projection('EPSG:900913'),
				displayProjection: new OpenLayers.Projection('EPSG:4326')});

			var osm_layer = new OpenLayers.Layer.OSM(
				'OpenStreetMap Layer'
			);
			
			var googleStreets = new OpenLayers.Layer.Google(
				"Google Streets",
				{}
			);

			var googleTerrain = new OpenLayers.Layer.Google(
				"Google Terrain",
				{type: google.maps.MapTypeId.TERRAIN}
			);

			var googleHybrid = new OpenLayers.Layer.Google(
				"Google Hybrid",
				{type: google.maps.MapTypeId.HYBRID}
			);

			var googleSatellite = new OpenLayers.Layer.Google(
				"Google Satellite",
				{type: google.maps.MapTypeId.SATELLITE}
			);

			
			osmFormat = new OpenLayers.Format.OSM({
				'internalProjection': new OpenLayers.Projection("EPSG:900913"),
    			'externalProjection': new OpenLayers.Projection("EPSG:4326")
			});
			
			//Initialise the vector layer using OpenLayers.Format.OSM
			vectorLayer = new OpenLayers.Layer.Vector("Vector"); /*new OpenLayers.Layer.Vector("Brussels POIs", {
 				strategies: [new OpenLayers.Strategy.Fixed()],
				protocol: new OpenLayers.Protocol.HTTP({
					url: "brussels_center_filtered.osm",   // relative or absolute URL to the .osm file
					format: osmFormat
					}),
					projection: new OpenLayers.Projection("EPSG:4326")
				});*/
			
			
			
			map.addLayers([googleStreets, googleTerrain, googleHybrid, googleSatellite, osm_layer, vectorLayer]);

			
				
			var selectFeatureControl = new OpenLayers.Control.SelectFeature(
					vectorLayer,
				{
					multiple: false,
					toggle: true,
					multipleKey: 'shiftKey'
				}
			);
			
			map.addControls([selectFeatureControl, new OpenLayers.Control.LayerSwitcher({})]);
			selectFeatureControl.activate();
			
			var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));
			map.setCenter (lonLat, zoom);
			
			/*
			if(!map.getCenter()){
				map.zoomToMaxExtent();
			}
			*/
		}
	
		function populateVectorLayer() {
			cleanVectorLayer();
			var queryType = $('[name="query_type"]:checked').val();
			var queryString = $('#query_string').val();
			alert('Query type value: ' + queryType + '\nQuery string: ' + queryString);
			var queryTypeParamName = "queryType";
			var queryStringParamName = "queryString";

			OpenLayers.Request.GET({
			    url: "features_data?"+queryTypeParamName+"="+queryType+"&amp;"+queryStringParamName+"="+queryString,
			    success: function(e) {
			        features = osmFormat.read(e.responseText);
			        vectorLayer.addFeatures(features);
			    }
			});
		}
	
		function cleanVectorLayer() {
			vectorLayer.destroyFeatures();
		}

		function addListeners() {
			$('div[#options] > #query_button').click(function() {
				populateVectorLayer();
			});
			$('div[#options] > #clear_map_button').click(function() {
				cleanVectorLayer();
			});
		}
		
		$(function() {
			initMap();
			addListeners();
		});
		
	})(jQuery);
	
	</script>


</head>



<body>

    <div id="options">
		<form>
		<input type="radio" name="query_type" value="poi" /> Point of interest<br />
		<input type="radio" name="query_type" value="street" /> Street<br />
		<input type="radio" name="query_type" value="logic_query" checked="checked"/> Logic Query<br />
		<textarea id="query_string" rows="3" cols="60"></textarea><br />
		</form>
		<input id="query_button" type="submit" value="Query" />
		<input id="clear_map_button" type="submit" value="Clear map" />
	</div>
	<div id="map_element" style="width: 500px; height: 500px;"></div>


</body>
</html>